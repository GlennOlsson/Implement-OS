out_file = "/home/cpe454/Desktop/OS/src/asm/interrupt_init.asm"

isr_count = 256
content = """
; FILE GENERATED BY /home/cpe454/Desktop/OS/src/py/init_ints_generator.py
; ANY CHANGES TO THIS FILE WILL BE OVERWRITTEN BY THE SCRIPT

extern setup_idt
extern generic_interrupt_handler

extern VGA_print_long_hex
extern VGA_display_char

global init_ints

"""

for i in range(256):
	content += f"global isr{i}\n"

content += """
section .bss
align 8
curr_isr:
	resb 8

error_code:
	resb 4


section .text
init_ints:
	cli ; dissable interrupts

	call setup_idt ; Setup IDT in C

	lidt [RAX] ; return value from c

	; enable interrupts in kmain

	ret

push_reg: ; Push all registers
	push RSI
	push RBP
	push RBX
	push RSP
	push R12
	push R13
	push R14
	push R15
	push RAX
	push RCX
	push RDX
	push RDI
	push R8
	push R9
	push R10
	push R11 ; 16 8-byte registers

	jmp [curr_isr]

pop_reg: ; Pop in FILO order, and iretq
	pop R11
	pop R10
	pop R9
	pop R8
	pop RDI
	pop RDX
	pop RCX
	pop RAX
	pop R15
	pop R14
	pop R13
	pop R12
	pop RSP
	pop RBX
	pop RBP
	pop RSI

	iretq
"""

for i in range(256):
	code = f"""
isr{i}:
	mov qword [curr_isr], isr{i}.after_push
	mov [error_code], RSP

	; Push all register for safety
	jmp push_reg

.after_push:

	mov RDI, {i} ; irq number, 1st arg
	mov RSI, error_code ; error code, 2nd arg. Not present in some isr but doesn't matter, loading some garbage instead 

	call generic_interrupt_handler 

	; pop registers and iretq from isr
	jmp pop_reg
"""
	content += code

with open(out_file, "w") as f:
	f.write(content)